flowchart TB
    subgraph Validator["Validator (Online)"]
        V1["Build Challenge:<br/>• Identities (name, DOB, address)<br/>• base_image + image_filename<br/>• variation_requests[] (type + intensity)<br/>• target_drand_round + reveal_timestamp"]
        V2["Receive Responses:<br/>• Name/DOB/Address variations<br/>• s3_submissions[]"]
        Vx["Online checks only:<br/>no download/decrypt/score images"]
        V3["KAV Scoring (Online):<br/>• Phonetic/orthographic similarity<br/>• Rule compliance<br/>• Cheat detection<br/>• Address validation via LDS v1"]
        V4["Get Previous Cycle Reputation<br/>(from post-validation)"]
        V5["Calculate Online Weight:<br/>KAV + prev-cycle reputation"]
        V6["SET WEIGHTS<br/>ON-CHAIN"]
        V7["Store submission refs<br/>for YANEZ"]
    end

    subgraph Miner["Miner"]
        M1["Generate KAV Variations:<br/>• Name <br/>• DOB<br/>• Address"]
        M1b["Generate UAV:<br/>Unknown Attack Vectors"]
        M2["Generate Image Variations<br/>(2-4 types × intensity)"]
        M3["Hash + Sign images<br/>with wallet"]
        M4["Encrypt images with<br/>drand timelock"]
        M5["Commit metadata:<br/>• s3_key<br/>• image_hash<br/>• signature<br/>• path_signature<br/>• variation_type"]
        M6["Return Response:<br/>KAV + UAV + s3_submissions[]"]
    end

    S3[("S3 Storage<br/>(yanez-miid-sn54)")]
    DR["Drand beacon<br/>(timelock reveal)"]

    subgraph PostVal["YANEZ Post-Validation (Offline)"]
        P0["After reveal window<br/>(~1 epoch)"]
        P1["Download from S3"]
        P2["Decrypt batch<br/>(after drand reveal)"]
        P3["Verify signature +<br/>hash + path_signature"]
        P4["Image Scoring:<br/>• Face match <br/>• Type/intensity compliance<br/>• Quality + anti-cheat"]
        P4b["UAV Validation:<br/>• Duplicate/recycling check<br/>• LDS v1 validation (API)<br/>• Semantic noise filter"]
        P6["Update Reputation<br/>for NEXT cycle"]
    end

    V1 -->|"IdentitySynapse"| Miner
    M1 --> M6
    M1b --> M6
    M2 --> M3 --> M4 -->|"Upload encrypted<br/>images"| S3
    M4 --> M5 -->|"refs"| M6
    M6 --> V2 --> Vx --> V3 --> V4 --> V5 --> V6
    V2 --> V7

    S3 -.->|"After reveal"| P0
    DR -.-> P2
    P0 --> P1 --> P2 --> P3 --> P4 --> P6
    V7 -.->|"Stored UAV submissions"| P4b
    P4b --> P6
    P6 -.->|"Used in<br/>NEXT cycle"| V4

    style V1 fill:#e0e7ff,stroke:#6366f1
    style V2 fill:#e0e7ff,stroke:#6366f1
    style Vx fill:#fef9c3,stroke:#ca8a04
    style V3 fill:#fee2e2,stroke:#ef4444
    style V4 fill:#fce7f3,stroke:#ec4899
    style V5 fill:#fee2e2,stroke:#ef4444
    style V6 fill:#fee2e2,stroke:#ef4444
    style V7 fill:#e0e7ff,stroke:#6366f1
    style M1 fill:#fef3c7,stroke:#f59e0b
    style M1b fill:#fce7f3,stroke:#ec4899
    style M2 fill:#fef3c7,stroke:#f59e0b
    style M3 fill:#fef3c7,stroke:#f59e0b
    style M4 fill:#fef3c7,stroke:#f59e0b
    style M5 fill:#fef3c7,stroke:#f59e0b
    style M6 fill:#fef3c7,stroke:#f59e0b
    style S3 fill:#f0fdf4,stroke:#22c55e
    style DR fill:#dbeafe,stroke:#3b82f6
    style P0 fill:#dbeafe,stroke:#3b82f6
    style P1 fill:#d1fae5,stroke:#10b981
    style P2 fill:#d1fae5,stroke:#10b981
    style P3 fill:#d1fae5,stroke:#10b981
    style P4 fill:#d1fae5,stroke:#10b981
    style P4b fill:#fce7f3,stroke:#ec4899
    style P6 fill:#d1fae5,stroke:#10b981
